## 쿠버네티스 강화

- 상용 환경의 특성
- 상용 쿠버네티스 환경에서 배운 교훈
- 클러스터 강화
- 쿠버네티스 생태계

### 상용 환경
- 클러스터에 제한을 설정해야한다
- 애플리케이션에 적합한 워크로드 유형을 사용한다.
- 모든 것에 레이블을 붙여라. 레이블은 매우 유연하며 객체 식별, 트래픽 라우팅, 배치 결정에 도움이 되는 많은 정보를 담을 수 있다.
- 기본값은 사용하지 않는다
- 핵심 쿠버네티스 컴포넌트의 기본값을 조정한다.
- 노드 포트로 서비스를 직접 노출하는 대신, 로드 밸런서를 사용한다
- 코드로 인프라를 관리하고 클라우드포메이션(Cloud Formation)이나 테라폼과 같은 프로비저닝 도구와 셰프(chef), 앤서블(ansible), 퍼펫(Puppet)과 같은 구성 도구를 사용한다.
- 쿠버네티스에 대한 전문 지식을 쌓기 전에는 상용 환경에서 스테이트풀 워크로드를 실행하지 않는다.
- 클러스터 상태를 유지하기 위한 고기능 템플릿 언어를 조사한다.
- RBAC를 사용해 최소 권한 원칙을 적용하고 가능한 한 관심사를 분리한다.
- 모든 클러스터 간의 의사 소통에 TLS를 사용한 보안 연결만 사용한다. 클러스터 내부의 `kubelet` 통신을 위해 TLS 및 인증서 순환을 설정할 수 있다.
- 쿠버네티스 관리에 익숙해질 때까지는 작은 클러스터를 많이 만들어본다. 운영 비용이 상승하겠지만, 더 많은 실패와 운영 부담을 겪으면서 빠르게 풍부한 경험을 쌓을 수 있을 것이다.
- 쿠버네티스를 잘 다룰 수 있게 되면 네임스페이스, 네트워크 세분화, 권한 부여 기능을 사용해 클러스터를 나누는 더 큰 클러스터를 구축한다.
- 대형 클러스터가 여러 개 있다면 `kubefed` 로 관리한다.
- 가능하면 사용 중인 CSP의 쿠버네티스 플랫폼 고가용성 기능을 사용한다. 예를 들면 GCP에서 GKE를 이용해 지역 클러스터를 실행한다. 이 기능은 리전을 여러 AZ에 노드를 분산해 단일 영역 에러에 대한 복원력과 마스터 노드의 무중단 운영을 위한 개념적 구성 요소를 제공한다.

#### 제한 설정
- CPU, 메모리, 요청

```bash
$ docker run --it --cpu-rt-runtime=950000 \
  --ulimit rtprio=99 \
  --memory=1024m \
  --cpus=".5"
  alpine /bin/sh
```

```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: mem-limit-range
spec:
  limits:
  - default:
      memory: 512Mi
    defaultRequest:
      memory: 256Mi
    type: Container
```


```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: cpu-demo-range
spec:
  limits:
  - max:
      cpu: "500m"
    min:
      cpu: "300m"
    type: Container
```
